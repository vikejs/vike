import { RepoLink, Link, Warning } from '@brillout/docpress'
import { Example, UseBati } from '../../components'
import { Tab, Tabs, TabList, TabPanel } from 'react-tabs'
import '../../components/tabs.css'

Deploying to [Cloudflare Workers](https://workers.cloudflare.com).

> For a much improved DX, instead of directly using Cloudflare Workers, we recommend using <Link href="#vike-cloudflare" />.

## `vike-cloudflare`

The [`vike-cloudflare`](https://github.com/vikejs/vike-cloudflare) extension enables zero-configuration deployment to [Cloudflare Pages](https://pages.cloudflare.com).

It will deploy prerendered routes as static files, and dynamic routes as [Pages Functions](https://developers.cloudflare.com/pages/functions/advanced-mode/).

> Instead of using `vike-cloudflare` you can manually integrate Cloudflare Pages yourself, see <Link href="/cloudflare#cloudflare-pages" doNotInferSectionTitle={true} />.

<UseBati>Cloudflare Pages with `vike-cloudflare`</UseBati>

### Without a server

```js
// +config.js

import vikeCloudflare from "vike-cloudflare/config";

export default {
  plugins: [vikeCloudflare]
}
```

### With a server

`vike-cloudflare` currently supports <Link href="/hono" /> and <Link href="/hattip" />

```js
// +config.js

import vikeCloudflare from "vike-cloudflare/config";

export default {
  plugins: [vikeCloudflare],
  server: {
    entry: "server/index.js"
  }
}
```

<Tabs>
  <TabList>
    <Tab>Hono</Tab>
    <Tab>Hattip</Tab>
  </TabList>

  <TabPanel>
    ```js
    // server/index.js

    import { Hono } from "hono";
    import { apply } from "vike-cloudflare/hono";
    import { serve } from "vike-cloudflare/hono/serve";

    function startServer() {
      const app = new Hono();
      const port = process.env.PORT || 3000;

      apply(app);

      return serve(app, { port: +port });
    }

    export default startServer();

    ```
  </TabPanel>
  <TabPanel>
    ```js
    // server/index.js

    import { createRouter } from "@hattip/router";
    import { apply } from "vike-cloudflare/hattip";
    import { serve } from "vike-cloudflare/hattip/serve";

    function startServer() {
      const router = createRouter();
      const port = process.env.PORT || 3000;

      apply(router);

      return serve(router, { port: +port });
    }

    export default startServer();
    ```
  </TabPanel>
</Tabs>

### Examples (Pages)

Example of using Vike with Cloudflare Pages with a Cloudflare worker:
 - <Example timestamp="2024.06" repo="vikejs/vike-cloudflare" /> - `vike-cloudflare` demos, with support for Plain Vike and Servers like <Link href="/hono" />.
 - <Example timestamp="2024.01" repo="travis-r6s/vike-cf-pages" /> - Advanced demo showcasing a lot of integrations such as REST, tRPC, GraphQL, Sentry, and Thumbprint.
 - <Example timestamp="2024.01" repo="osseonews/vike-app-cfp" />
 - <Example timestamp="2022.04" repo="Immortalin/vite-plugin-ssr-cloudflare-pages-demo" />
   > vite-plugin-ssr was the [previous name of Vike](https://vite-plugin-ssr.com/vike).

## Examples

 - React: <RepoLink path='/examples/cloudflare-workers-react/' />
 - React + SSR Streaming: <RepoLink path='/examples/cloudflare-workers-react-full/' />
 - Vue: <RepoLink path='/examples/cloudflare-workers-vue/' />


## Wrangler

Cloudflare Workers requires your entire worker code to be bundled into a single file.

> Cloudflare uses the term "worker code" to denote server code that is run on its edge infrastructure.

We recommend using [Wrangler v2](https://github.com/cloudflare/wrangler2) (the v2 uses [esbuild](https://esbuild.github.io/) under the hood).


## vite-plugin-cloudflare

You can also use [vite-plugin-cloudflare](https://github.com/Aslemammad/vite-plugin-cloudflare) which enables you to simply use `$ vike build` and `$ vike dev` to build and develop your worker code (including HMR support!).

Example: [GitHub > `Aslemammad/vite-plugin-cloudflare` > `examples/vite-plugin-ssr/`](https://github.com/Aslemammad/vite-plugin-cloudflare/tree/main/examples/vite-plugin-ssr).

> vite-plugin-ssr was the [previous name of Vike](https://vite-plugin-ssr.com/vike).


## Extend 1MB limit

The bundle size of your worker should not exceed 1MB, but you can request sizes of up to 100MB and beyond:
 - [Cloudflare Workers > Larger Scripts](https://www.cloudflare.com/larger-scripts-on-workers-early-access/)
 - [Cloudflare Workers > Limits > Worker Size](https://developers.cloudflare.com/workers/platform/limits/#worker-size)


## Cloudflare Pages

You can also use [Cloudflare Pages](https://developers.cloudflare.com/pages/) to deploy your Vike app.

To deploy your SSR worker use a [Cloudflare Pages Function](https://developers.cloudflare.com/pages/platform/functions/).

Example:
  - <Example timestamp="2022.04" repo="Immortalin/vite-plugin-ssr-cloudflare-pages-demo" />
   > vite-plugin-ssr was the [previous name of Vike](https://vite-plugin-ssr.com/vike).

See also:
 - [Wrangler 2.0 â€” a new developer experience for Cloudflare Workers](https://blog.cloudflare.com/wrangler-v2-beta/)


## Development

For a significantly faster development experience, we recommend, whenever possible, using Vite's development server instead of wrangler (or an Express.js server).

This means:
 - Skip `wrangler` / Cloudflare Workers altogether while developing your app.
 - Use `wrangler dev` to preview your worker.
 - Use `wrangler publish` to deploy your worker to Cloudflare Workers.

See the setup of the [examples](#examples).


## Universal `fetch()`

When using Node.js for development and Cloudflare Workers for production, you may need a `fetch()` function that works in both environments.

But libraries such as `node-fetch` or `cross-fetch` typically don't work with Cloudflare Workers.

What you can do is to define a fetch function at `pageContext.fetch` that works in all environments.
The trick is to add a different `fetch()` implementation to `pageContextInit` at <Link text={<code>renderPage(pageContextInit)</code>} href="/renderPage" />.

Example: <RepoLink path='/examples/cloudflare-workers-react-full#universal-fetch' />.
