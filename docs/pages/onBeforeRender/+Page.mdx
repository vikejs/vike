import { UiFrameworkExtension, ConfigSpec } from '../../components'
import { Link } from '@brillout/docpress'

<ConfigSpec
  env={<>server (<Link href="#environment">configurable</Link>)</>}
  cumulative={false}
/>

> The `onBeforeRender()` hook is for advanced use cases. We generally recommend using the
> <Link href="/data">`data()` hook</Link> instead, and/or <Link href="/extensions">Vike extensions</Link>
> that automatically integrate data fetching tools (RPC with Telefunc/tRPC, REST with Tanstack Query, GraphQL with Apollo/Relay, etc).

The most notable use case for the `onBeforeRender()` hook is deep integration with data fetching tools.

For simple data fetching needs, use the <Link href="/data">`data()` hook</Link> instead. As a strategy to decide which one to use, always first try to use `data()` and only use `onBeforeRender()` as a fallback if `data()` doesn't work out.

The `onBeforeRender()` hook can be used to orchestrate multiple <Link href="/meta">custom hooks and settings</Link>, see:
 - <Link href="#onbeforerender-meta" doNotInferSectionTitle />
 - <Link href="#advanced-example" />


## `onBeforeRender()` VS `data()`

The central difference between the two hooks is that the value returned by `data()` always sets the value of `pageContext.data`, whereas `onBeforeRender()` can set multiple <Link href="/pageContext">`pageContext`</Link> values.

```ts
// /pages/some-page/+data.ts
// Environment: server

export { data }

function data() {
  const someValue = /* ... */
  // pageContext.data === someValue
  return someValue
}
```

```ts
// /pages/some-page/+onBeforeRender.ts
// Environment: server

export { onBeforeRender }

function onBeforeRender() {
  const someValue1 = /* ... */
  const someValue2 = /* ... */
  // pageContext.prop1 === someValue1
  // pageContext.prop2 === someValue2
  return {
    pageContext: {
      prop1: someValue1,
      prop2: someValue2
    }
  }
}
```

Another difference is that the entire `pageContext.data` value is always sent to the client-side, whereas with `onBeforeRender()` you can (and must) decide which values are sent to the client-side by using <Link href="/passToClient">`passToClient`</Link>.

In a nutshell: while `onBeforeRender()` requires more manual work, it also gives you more control.


## Environment

Like `data()`, the `onBeforeRender()` hook always runs on the server-side by default. By using <Link href="/file-env">`.shared.js` or `.client.js`</Link> you can tell Vike to run `onBeforeRender()` on the client-side instead, see <Link href="/data#environment" />.


## `onBeforeRender()` + `meta`

Using `onBeforeRender()` together with custom hooks and settings (see <Link href="/meta">`meta`</Link>) is a powerful technique enabling you to implement your own tailored DX.

For example.

A custom setting `+sql.js` (created with `meta`):

```ts
// /pages/user/+sql.ts
export default { modelName: 'User', select: ['firstName', 'lastName'] }
```

```ts
// /pages/product/+sql.ts
export default { modelName: 'Product', select: ['name', 'price'] }
```

A single global `onBeforeRender()` hook orchestrating the custom setting:

```ts
// /pages/+onBeforeRender.ts
// Environment: server

export { onBeforeRender }

import type { PageContextServer } from 'vike/types'
import { runQuery } from 'some-sql-engine'

async function onBeforeRender(pageContext: PageContextServer) {
  // The value exported by /pages/**/+sql.js is available at pageContext.config.sql
  const { sql } = pageContext.config
  const data = await runQuery(sql)
  // ...
}
```

See full implementation at <Link href="/meta#example-sql" doNotInferSectionTitle />.


## Override

There can be only one `onBeforeRender()` hook per page. For example, if you define a global `onBeforeRender()` hook at `/pages/+onBeforeRender.js` as well as a page-specific one at `/pages/star-wars/+onBeforeRender.js` then the page-specific one overrides the global one. See <Link href="/config#inheritance" />.

> If you want multiple `onBeforeRender()` hooks, then consider:
> - <Link href="/meta">Creating custom hooks</Link> instead: you can then use one global `onBeforeRender()` hook that orchestrates many custom hooks.
> - Using <Link href="/data">`data()` hooks</Link>: you can then use one global `onBeforeRender()` while using page-specific `data()` hooks.

You can also suppress globally defined `onBeforeRender()` hooks on a per-page basis:
```ts
// /pages/+onBeforeRender.ts

// Some global onBeforeRender() hook
export default () => {
  // ...
}
```
```ts
// /pages/some-page/+config.ts

import type { Config } from 'vike/types'

export default {
  // Suppress the global onBeforeRender() hook
  onBeforeRender: null
} satisfies Config
```


## Advanced example

The following is an advanced example of using `onBeforeRender()` with `meta` in order to integrate data fetching tools. In particular, this approach can be used for advanced integration with GraphQL tools.

> If you use a custom renderer instead of <UiFrameworkExtension name noLink />, then you can modify your `onRenderHtml()`/`onRenderClient()` hooks instead of doing the following.

```ts
// /pages/+config.ts
// Environment: config

import type { Config } from 'vike/types'

export default {
  // Pass the GraphQL cache to the client-side
  passToClient: ['cache'],
  // Modify/create hooks
  meta: {
    onBeforeRender: {
      // Modify the onBeforeRender() hook to run on both the server- and client-side
      env: { client: true, server: true }
    },
    // Create new hook
    onBeforeRenderHtml: {
      env: { server: true }
    },
    // Create new hook
    onBeforeRenderClient: {
      env: { client: true }
    }
  }
} satisfies Config
```
> See:
>  - <Link href="/meta" />
>  - <Link href="/passToClient" />

```ts
// /pages/+onBeforeRender.ts
// Environment: server & client

export { onBeforeRender }

import type { PageContext } from 'vike/types'

async function onBeforeRender(pageContext: PageContext) {
  // When run on the server-side
  if (pageContext.config.onBeforeRenderHtml) {
    const { pageContext } = await onBeforeRenderHtml(pageContext)
    return { pageContext }
  }
  // When run on the client-side
  if (pageContext.config.onBeforeRenderClient) {
    await onBeforeRenderClient(pageContext)
  }
}
```

```ts
// /pages/+onBeforeRenderHtml.tsx
// Environment: server

export { onBeforeRenderHtml }

import type { PageContextServer } from 'vike/types'
import { renderToHtml } from 'my-graphql-tool/server'

async function onBeforeRenderHtml(pageContext: PageContextServer) {
  const { Page } = pageContext
  // `cache` contains the data fetched by GraphQL
  const { cache, html } = await renderToHtml(<Page />)
  return {
    pageContext: {
      pageHtml: html,
      cache
    }
  }
}
```

```ts
// /pages/+onBeforeRenderClient.tsx
// Environment: client

export { onBeforeRenderClient }

import type { PageContextClient } from 'vike/types'
import { hydrate } from 'my-ui-framework/client'
import { CacheProvider } from 'my-graphql-tool/client'

function onBeforeRenderClient(pageContext: PageContextClient) {
  const { Page, cache } = pageContext
  hydrate(
    // Re-use the `cache` data that was fetched on the server-side
    <CacheProvider cache={cache}>
      <Page />
    </CacheProvider>,
    document.getElementById('root')
  )
}
```


## See also

- <Link href="/data" />
- <Link href="/onBeforeRenderHtml" />
- <Link href="/onBeforeRenderClient" />
- <Link href="/hooks" />
